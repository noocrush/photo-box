<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œå“åˆ—è¡¨ - å†™çœŸåŒ£å­</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    /* é¡µé¢ç‰¹å®šæ ·å¼ */
    #work-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .work-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; position: relative; }
    .work-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .work-cover { width: 100%; height: 240px; object-fit: cover; background: #f0f0f0; background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0xMDAgMjVjNDEuNDIgMCA3NSAzMy41OCA3NSA3NXMtMzMuNTggNzUtNzUgNzVTMjUgMTQxLjQyIDI1IDEwMCA1OC41OCAyNSAxMDAgMjV6bTAgMTIwYzU5LjU4IDAgMTA1LTQ1LjQyIDEwNS0xMDVTMTU5LjU4IDAgMTAwIDBTMjUgNDUuNDIgMjUgMTAwczQ1LjQyIDEwNSAxMDUgMTA1eiIvPjxwYXRoIGQ9Ik0xMDAgNzVWMTgwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMTAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvZz48L3N2Zz4='); background-repeat: no-repeat; background-position: center; }
    .work-info { padding: 10px; text-align: center; }
    .empty-tip { text-align: center; padding: 50px; color: #999; font-size: 18px; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); color: white; display: none; align-items: center; justify-content: center; font-size: 20px; z-index: 10000; }
    
    /* æ”¶è—æŒ‰é’®æ ·å¼ */
    .model-favorite-btn, .work-favorite-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      z-index: 10;
      transition: all 0.2s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .model-favorite-btn:hover, .work-favorite-btn:hover {
      background: rgba(0,0,0,0.7);
      transform: scale(1.1);
    }
    
    .model-favorite-btn.favorited, .work-favorite-btn.favorited {
      color: #ffd700;
      background: rgba(255, 215, 0, 0.2);
    }
    
    /* å³é”®èœå•æ ·å¼ */
    .context-menu {
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      min-width: 150px;
      padding: 8px 0;
    }
    
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: background-color 0.2s;
    }
    
    .context-menu-item:hover {
      background-color: #f0f0f0;
    }
    
    .context-menu-item:active {
      background-color: #e0e0e0;
    }
    
    /* å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ */
    .image-viewer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 99999; display: none; }
    .viewer-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
    .viewer-image { max-width: 90%; max-height: 90%; transition: transform 0.2s ease; cursor: grab; }
    .viewer-image.grabbing { cursor: grabbing; }
    .viewer-info { position: absolute; top: 20px; left: 20px; color: white; font-size: 14px; }
    .viewer-close { position: absolute; top: 20px; right: 20px; font-size: 24px; color: white; cursor: pointer; }
    .viewer-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
    .viewer-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer; }
    .viewer-btn:hover { background: rgba(255,255,255,0.3); }
  </style>
</head>
<body>
  <!-- å·¦ä¾§å¯¼èˆªæ  -->
  <nav class="sidebar">
    <ul class="nav-menu">
      <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span> ä¸»é¡µ</a></li>
      <li class="nav-item"><a href="search.html" class="nav-link"><span class="nav-icon">ğŸ”</span> æœç´¢</a></li>
      <li class="nav-item"><a href="favorites.html" class="nav-link"><span class="nav-icon">â­</span> æ”¶è—</a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link"><span class="nav-icon">âš™ï¸</span> è®¾ç½®</a></li>
      <li class="nav-item"><a href="about.html" class="nav-link"><span class="nav-icon">â„¹ï¸</span> å…³äº</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="header">
      <button class="back-btn" id="back-btn">â† è¿”å›</button>
      <h1 id="model-name">ä½œå“åˆ—è¡¨</h1>
    </div>

    <div id="work-grid">
      <div class="empty-tip">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <div class="loading-overlay" id="loading-overlay">åŠ è½½å›¾ç‰‡æŸ¥çœ‹å™¨...</div>

  <!-- å³é”®èœå• -->
  <div class="context-menu" id="work-context-menu">
    <div class="context-menu-item" id="change-work-cover">æ›´æ¢å°é¢</div>
    <div class="context-menu-item" id="delete-work">åˆ é™¤ä½œå“</div>
  </div>

  <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
  <div class="image-viewer" id="image-viewer">
    <div class="viewer-content" id="viewer-content">
      <img src="" alt="æŸ¥çœ‹å›¾ç‰‡" class="viewer-image" id="viewer-image">
      <div class="viewer-info" id="viewer-info">1/1 (100%)</div>
      <div class="viewer-close" id="viewer-close">Ã—</div>
      <div class="viewer-controls">
        <button class="viewer-btn" id="btn-prev">ä¸Šä¸€å¼ </button>
        <button class="viewer-btn" id="btn-zoom-out">-</button>
        <button class="viewer-btn" id="btn-reset">100%</button>
        <button class="viewer-btn" id="btn-zoom-in">+</button>
        <button class="viewer-btn" id="btn-next">ä¸‹ä¸€å¼ </button>
      </div>
    </div>
  </div>

  <script src="scripts/nav-handler.js"></script>
  <script>
    // å…¼å®¹APIè°ƒç”¨
    const electron = window.require ? window.require('electron') : null;
    const ipcRenderer = electron ? electron.ipcRenderer : null;

    // ä½¿ç”¨window.electronAPIï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºå…¼å®¹ç‰ˆæœ¬
    if (!window.electronAPI) {
      window.electronAPI = {
        getImageBase64: (imagePath) => ipcRenderer.invoke('getImageBase64', imagePath),
        getCurrentShortcuts: () => ipcRenderer.invoke('get-current-shortcuts'),
        getWheelSettings: () => ipcRenderer.invoke('get-wheel-settings'),
        showOpenDialog: (options) => ipcRenderer.invoke('show-open-dialog', options)
      };
    } else {
      // ç¡®ä¿å¿…è¦çš„æ–¹æ³•å­˜åœ¨
      if (!window.electronAPI.getCurrentShortcuts) {
        window.electronAPI.getCurrentShortcuts = () => ipcRenderer.invoke('get-current-shortcuts');
      }
      if (!window.electronAPI.getWheelSettings) {
        window.electronAPI.getWheelSettings = () => ipcRenderer.invoke('get-wheel-settings');
      }
    }

    // ä½¿ç”¨window.electronAPIä»£æ›¿æœ¬åœ°electronAPI
    const electronAPI = window.electronAPI;

    // å…¨å±€å˜é‡
    let currentImages = [];
    let currentIndex = 0;
    let zoomLevel = 1.0;
    let currentWork = null; // ä¿å­˜å½“å‰ä½œå“ä¿¡æ¯
    let selectedWorkIndex = null; // å½“å‰é€‰ä¸­çš„ä½œå“ç´¢å¼•
    let shortcuts = {
      nextImage: 'ArrowRight',
      prevImage: 'ArrowLeft',
      zoomIn: 'Ctrl+Plus',
      zoomOut: 'Ctrl+Minus',
      resetZoom: 'Ctrl+0',
      closeViewer: 'Escape'
    };
    // ç®€åŒ–çš„æ»šè½®è®¾ç½®
    let wheelSettings = {
      wheelMode: 'zoom',  // zoom=ç¼©æ”¾ï¼Œpage=ç¿»é¡µï¼Œnone=æ— æ“ä½œ
      zoomStep: 0.05
    };
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let translateX = 0;
    let translateY = 0;

    // DOMå…ƒç´ 
    const workGrid = document.getElementById('work-grid');
    const modelNameEl = document.getElementById('model-name');
    const loadingOverlay = document.getElementById('loading-overlay');
    const imageViewer = document.getElementById('image-viewer');
    const viewerImage = document.getElementById('viewer-image');
    const viewerInfo = document.getElementById('viewer-info');
    const viewerClose = document.getElementById('viewer-close');
    const viewerContent = document.getElementById('viewer-content');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnReset = document.getElementById('btn-reset');
    // ç§»é™¤btnFavorite
    
    // å³é”®èœå•å…ƒç´ 
    const workContextMenu = document.getElementById('work-context-menu');
    const changeWorkCover = document.getElementById('change-work-cover');
    const deleteWork = document.getElementById('delete-work');
    
    // ç»‘å®šæ‰€æœ‰äº‹ä»¶
    function bindEvents() {
      // æŒ‰é’®äº‹ä»¶
      btnPrev.addEventListener('click', () => loadImageByIndex(currentIndex - 1));
      btnNext.addEventListener('click', () => loadImageByIndex(currentIndex + 1));
      btnZoomIn.addEventListener('click', () => zoomImage(wheelSettings.zoomStep));
      btnZoomOut.addEventListener('click', () => zoomImage(-wheelSettings.zoomStep));
      btnReset.addEventListener('click', resetZoom);
      viewerClose.addEventListener('click', closeViewer);
      // æ”¶è—æŒ‰é’®äº‹ä»¶
      document.addEventListener('click', (e) => {
        const favoriteBtn = e.target.closest('.work-favorite-btn');
        if (favoriteBtn) {
          e.stopPropagation();
          const workId = favoriteBtn.dataset.workId;
          const isFav = isFavorite(workId);
          
          if (isFav) {
            removeFavorite(workId);
            favoriteBtn.classList.remove('favorited');
            favoriteBtn.title = 'æ”¶è—';
          } else {
            addFavorite(workId);
            favoriteBtn.classList.add('favorited');
            favoriteBtn.title = 'å–æ¶ˆæ”¶è—';
          }
        }
      });
      
      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (imageViewer.style.display !== 'block') return;
        
        if (isShortcutMatch(e, shortcuts.nextImage)) {
          e.preventDefault();
          loadImageByIndex(currentIndex + 1);
        } else if (isShortcutMatch(e, shortcuts.prevImage)) {
          e.preventDefault();
          loadImageByIndex(currentIndex - 1);
        } else if (isShortcutMatch(e, shortcuts.zoomIn)) {
          e.preventDefault();
          zoomImage(wheelSettings.zoomStep);
        } else if (isShortcutMatch(e, shortcuts.zoomOut)) {
          e.preventDefault();
          zoomImage(-wheelSettings.zoomStep);
        } else if (isShortcutMatch(e, shortcuts.resetZoom)) {
          e.preventDefault();
          resetZoom();
        } else if (isShortcutMatch(e, shortcuts.closeViewer)) {
          e.preventDefault();
          closeViewer();
        }
      });
      
      // æ»šè½®äº‹ä»¶ï¼ˆæ ¸å¿ƒï¼šç®€åŒ–ç‰ˆï¼‰
      viewerContent.addEventListener('wheel', handleWheelEvent);
      
      // å›¾ç‰‡æ‹–æ‹½
      viewerImage.addEventListener('mousedown', (e) => {
        if (zoomLevel <= 1.0) return;
        isDragging = true;
        viewerImage.classList.add('grabbing');
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
      });
      
      document.addEventListener('mouseup', () => {
        isDragging = false;
        viewerImage.classList.remove('grabbing');
      });
      
      // ç‚¹å‡»ç©ºç™½å¤„å…³é—­
      imageViewer.addEventListener('click', (e) => {
        if (e.target === imageViewer) {
          closeViewer();
        }
      });
      
      // è¿”å›æŒ‰é’®
      document.getElementById('back-btn').addEventListener('click', () => {
        window.history.back();
      });
      
      // å³é”®èœå•äº‹ä»¶
      workGrid.addEventListener('contextmenu', (e) => {
        const workCard = e.target.closest('.work-card');
        if (workCard) {
          e.preventDefault();
          selectedWorkIndex = parseInt(workCard.dataset.workIndex);
          
          // æ˜¾ç¤ºèœå•
          workContextMenu.style.left = e.clientX + 'px';
          workContextMenu.style.top = e.clientY + 'px';
          workContextMenu.style.display = 'block';
        }
      });
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
      document.addEventListener('click', (e) => {
        if (!workContextMenu.contains(e.target) && !e.target.closest('.work-card')) {
          workContextMenu.style.display = 'none';
          selectedWorkIndex = null;
        }
      });
      
      // æ›´æ¢å°é¢äº‹ä»¶
      changeWorkCover.addEventListener('click', async () => {
        if (selectedWorkIndex === null) return;
        
        try {
          // è·å–å½“å‰ä½œå“çš„å°é¢è·¯å¾„
          const modelData = JSON.parse(localStorage.getItem('selectedModel') || '{}');
          const currentWork = modelData.works[selectedWorkIndex];
          const currentCoverPath = currentWork?.cover;
          
          // æå–å½“å‰å°é¢çš„ç›®å½•ä½œä¸ºdefaultPath
          const path = window.require('path');
          const defaultPath = currentCoverPath ? path.dirname(currentCoverPath) : '';
          
          // ä½¿ç”¨electronAPI.showOpenDialogé€‰æ‹©æ–°å°é¢
          const result = await window.electronAPI.showOpenDialog({
            properties: ['openFile'],
            filters: [
              { name: 'Images', extensions: ['png', 'jpg', 'jpeg', 'gif', 'bmp'] }
            ],
            defaultPath: defaultPath
          });
          
          if (result.canceled || result.filePaths.length === 0) return;
          
          const newCoverPath = result.filePaths[0];
          const scanResult = JSON.parse(localStorage.getItem('scanResult') || '[]');
          
          // æ›´æ–°å½“å‰æ¨¡å‹æ•°æ®ä¸­çš„ä½œå“å°é¢
          modelData.works[selectedWorkIndex].cover = newCoverPath;
          localStorage.setItem('selectedModel', JSON.stringify(modelData));
          
          // åœ¨æ‰«æç»“æœä¸­æ‰¾åˆ°å¯¹åº”çš„æ¨¡ç‰¹å’Œä½œå“å¹¶æ›´æ–°
          const modelIndex = scanResult.findIndex(m => m.id === modelData.id);
          if (modelIndex !== -1) {
            scanResult[modelIndex].works[selectedWorkIndex].cover = newCoverPath;
            localStorage.setItem('scanResult', JSON.stringify(scanResult));
            // åŒæ—¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­
            await window.electronAPI.saveScanResult(scanResult);
          }
          
          // æ›´æ–°ç•Œé¢
          const workCard = document.querySelector(`[data-work-index="${selectedWorkIndex}"]`);
          if (workCard) {
            const coverImg = workCard.querySelector('.work-cover');
            const base64 = await electronAPI.getImageBase64(newCoverPath);
            coverImg.src = base64;
            coverImg.dataset.imgPath = newCoverPath;
          }
          
          workContextMenu.style.display = 'none';
          selectedWorkIndex = null;
          
        } catch (err) {
          alert('æ›´æ¢å°é¢å¤±è´¥ï¼š' + err.message);
          workContextMenu.style.display = 'none';
          selectedWorkIndex = null;
        }
      });
      
      // åˆ é™¤ä½œå“äº‹ä»¶
      deleteWork.addEventListener('click', async () => {
        if (selectedWorkIndex === null) return;
        
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä½œå“å—ï¼Ÿ')) {
          workContextMenu.style.display = 'none';
          selectedWorkIndex = null;
          return;
        }
        
        try {
          const modelData = JSON.parse(localStorage.getItem('selectedModel') || '{}');
          const scanResult = JSON.parse(localStorage.getItem('scanResult') || '[]');
          
          // ä»å½“å‰æ¨¡å‹æ•°æ®ä¸­åˆ é™¤ä½œå“
          modelData.works.splice(selectedWorkIndex, 1);
          localStorage.setItem('selectedModel', JSON.stringify(modelData));
          
          // åœ¨æ‰«æç»“æœä¸­æ‰¾åˆ°å¯¹åº”çš„æ¨¡ç‰¹å¹¶æ›´æ–°ä½œå“åˆ—è¡¨
          const modelIndex = scanResult.findIndex(m => m.id === modelData.id);
          if (modelIndex !== -1) {
            scanResult[modelIndex].works.splice(selectedWorkIndex, 1);
            localStorage.setItem('scanResult', JSON.stringify(scanResult));
            // åŒæ—¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­
            await window.electronAPI.saveScanResult(scanResult);
          }
          
          // æ›´æ–°ç•Œé¢
          const workCard = document.querySelector(`[data-work-index="${selectedWorkIndex}"]`);
          if (workCard) {
            workCard.remove();
          }
          
          // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä½œå“
          if (modelData.works.length === 0) {
            workGrid.innerHTML = '<div class="empty-tip">è¯¥æ¨¡ç‰¹æš‚æ— ä½œå“</div>';
          }
          
          workContextMenu.style.display = 'none';
          selectedWorkIndex = null;
          
        } catch (err) {
          alert('åˆ é™¤ä½œå“å¤±è´¥ï¼š' + err.message);
          workContextMenu.style.display = 'none';
          selectedWorkIndex = null;
        }
      });
    }
    
    // æ›´æ–°æŸ¥çœ‹å™¨ä¿¡æ¯
    function updateViewerInfo() {
      const percent = Math.round(zoomLevel * 100);
      viewerInfo.textContent = `${currentIndex + 1}/${currentImages.length} (${percent}%)`;
      // ç§»é™¤updateFavoriteButtonè°ƒç”¨
    }
    
    // åŠ è½½æŒ‡å®šç´¢å¼•çš„å›¾ç‰‡
    async function loadImageByIndex(index) {
      if (index < 0 || index >= currentImages.length) return;
      
      currentIndex = index;
      translateX = 0;
      translateY = 0;
      
      try {
        const base64 = await electronAPI.getImageBase64(currentImages[currentIndex]);
        viewerImage.src = base64;
        viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        updateViewerInfo();
        // ç§»é™¤updateFavoriteButtonè°ƒç”¨
        imageViewer.style.display = 'block';
      } catch (err) {
        alert('åŠ è½½å›¾ç‰‡å¤±è´¥ï¼š' + err.message);
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    // ç¼©æ”¾å›¾ç‰‡
    function zoomImage(delta) {
      zoomLevel += delta;
      zoomLevel = Math.max(0.1, Math.min(3.0, zoomLevel));
      viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
      updateViewerInfo();
    }

    // é‡ç½®ç¼©æ”¾å’Œä½ç½®
    function resetZoom() {
      zoomLevel = 1.0;
      translateX = 0;
      translateY = 0;
      viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
      updateViewerInfo();
    }

    // å…³é—­æŸ¥çœ‹å™¨
    function closeViewer() {
      imageViewer.style.display = 'none';
      currentImages = [];
      currentIndex = 0;
      currentWork = null; // æ¸…ç©ºå½“å‰ä½œå“ä¿¡æ¯
      resetZoom();
    }

    // è§£æå¿«æ·é”®å­—ç¬¦ä¸²
    function parseShortcut(shortcutStr) {
      const parts = shortcutStr.split('+');
      return {
        ctrl: parts.includes('Ctrl'),
        shift: parts.includes('Shift'),
        alt: parts.includes('Alt'),
        key: parts.pop()
      };
    }

    // æ£€æŸ¥å¿«æ·é”®åŒ¹é…
    function isShortcutMatch(e, shortcutStr) {
      const shortcut = parseShortcut(shortcutStr);
      return (
        e.ctrlKey === shortcut.ctrl &&
        e.shiftKey === shortcut.shift &&
        e.altKey === shortcut.alt &&
        (e.key === shortcut.key || 
         (shortcut.key === 'Plus' && e.key === '+') || 
         (shortcut.key === 'Minus' && e.key === '-') ||
         (shortcut.key === 'Esc' && e.key === 'Escape'))
      );
    }

    // ç®€åŒ–çš„æ»šè½®äº‹ä»¶å¤„ç†
    function handleWheelEvent(e) {
      e.preventDefault();
      
      // æ ¹æ®æ»šè½®æ¨¡å¼å¤„ç†
      switch (wheelSettings.wheelMode) {
        case 'page':
          // æ»šè½®ç¿»é¡µï¼šå‘ä¸Š/å‘å·¦=ä¸Šä¸€å¼ ï¼Œå‘ä¸‹/å‘å³=ä¸‹ä¸€å¼ 
          if (e.deltaY > 0 || e.deltaX > 0) {
            loadImageByIndex(currentIndex + 1); // ä¸‹ä¸€å¼ 
          } else {
            loadImageByIndex(currentIndex - 1); // ä¸Šä¸€å¼ 
          }
          break;
        case 'zoom':
          // æ»šè½®ç¼©æ”¾ï¼šå‘ä¸Š=æ”¾å¤§ï¼Œå‘ä¸‹=ç¼©å°
          if (e.deltaY < 0) {
            zoomImage(wheelSettings.zoomStep); // æ”¾å¤§
          } else {
            zoomImage(-wheelSettings.zoomStep); // ç¼©å°
          }
          break;
        case 'none':
          // æ— æ“ä½œ
          break;
      }
    }

    // åŠ è½½é…ç½®
    async function loadAllConfigs() {
      try {
        // åŠ è½½å¿«æ·é”®
        const loadedShortcuts = await electronAPI.getCurrentShortcuts();
        shortcuts = { ...shortcuts, ...loadedShortcuts };
        // åŠ è½½æ»šè½®è®¾ç½®
        const loadedWheel = await electronAPI.getWheelSettings();
        wheelSettings = { ...wheelSettings, ...loadedWheel };
      } catch (err) {
        console.error('åŠ è½½é…ç½®å¤±è´¥ï¼š', err);
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllConfigs();
      await loadModelData();
      bindEvents();
      
      // ç›‘å¬æ»šè½®è®¾ç½®æ›´æ–°
      if (ipcRenderer) {
        ipcRenderer.on('wheel-settings-updated', (_, newSettings) => {
          wheelSettings = { ...wheelSettings, ...newSettings };
          alert('æ»šè½®è®¾ç½®å·²æ›´æ–°ï¼Œä¸‹æ¬¡æ‰“å¼€å›¾ç‰‡ç”Ÿæ•ˆ');
        });
      }
    });

    // åŠ è½½æ¨¡ç‰¹æ•°æ®
    async function loadModelData() {
      try {
        const modelData = JSON.parse(localStorage.getItem('selectedModel') || '{}');
        if (!modelData.id) {
          workGrid.innerHTML = '<div class="empty-tip">æœªé€‰æ‹©æ¨¡ç‰¹ï¼Œè¯·è¿”å›é¦–é¡µ</div>';
          return;
        }

        modelNameEl.textContent = `${modelData.name} - ä½œå“åˆ—è¡¨`;

        if (modelData.works.length === 0) {
          workGrid.innerHTML = '<div class="empty-tip">è¯¥æ¨¡ç‰¹æš‚æ— ä½œå“</div>';
          return;
        }

        let html = '';
        modelData.works.forEach((work, workIndex) => {
          const isFav = isFavorite(work.id);
          html += `
            <div class="work-card" data-work-index="${workIndex}">
              <button class="work-favorite-btn ${isFav ? 'favorited' : ''}" data-work-id="${work.id}" title="${isFav ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}"></button>
              <img class="work-cover" src="" data-img-path="${work.cover}">
              <div class="work-info">
                <div>${work.name}</div>
                <div style="font-size:12px;color:#666">${work.images.length} å¼ å›¾ç‰‡</div>
              </div>
            </div>
          `;
        });
        workGrid.innerHTML = html;

        // åŠ è½½å°é¢å›¾ç‰‡
        document.querySelectorAll('.work-card').forEach(async card => {
          const imgPath = card.querySelector('.work-cover').dataset.imgPath;
          const base64 = await electronAPI.getImageBase64(imgPath);
          card.querySelector('.work-cover').src = base64;

          card.addEventListener('click', async (e) => {
            // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æ”¶è—æŒ‰é’®æˆ–å…¶å†…éƒ¨å…ƒç´ ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ‰“å¼€æŸ¥çœ‹å™¨
            if (e.target.closest('.work-favorite-btn')) {
              return;
            }
            
            const workIndex = parseInt(card.dataset.workIndex);
            const work = modelData.works[workIndex];
            currentWork = work; // ä¿å­˜å½“å‰ä½œå“ä¿¡æ¯
            currentImages = work.images;
            currentIndex = 0;
            zoomLevel = 1.0;
            translateX = 0;
            translateY = 0;

            loadingOverlay.style.display = 'flex';
            try {
              const base64 = await electronAPI.getImageBase64(currentImages[currentIndex]);
              viewerImage.src = base64;
              viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
              updateViewerInfo();
              imageViewer.style.display = 'block';
            } catch (err) {
              alert('åŠ è½½å›¾ç‰‡å¤±è´¥ï¼š' + err.message);
            } finally {
              loadingOverlay.style.display = 'none';
            }
          });
        });
      } catch (err) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼š', err);
        workGrid.innerHTML = `<div class="empty-tip" style="color:red;">åŠ è½½å¤±è´¥ï¼š${err.message}</div>`;
      }
    }

    // æ”¶è—åŠŸèƒ½ç›¸å…³å‡½æ•°
    function getFavorites() {
      try {
        const favorites = localStorage.getItem('workFavorites'); // ä»å›¾ç‰‡æ”¶è—æ”¹ä¸ºä½œå“æ”¶è—
        return favorites ? JSON.parse(favorites) : [];
      } catch (err) {
        console.error('è·å–æ”¶è—å¤±è´¥ï¼š', err);
        return [];
      }
    }

    function isFavorite(workId) {
      const favorites = getFavorites();
      return favorites.includes(workId);
    }

    function addFavorite(workId) {
      try {
        const favorites = getFavorites();
        if (!favorites.includes(workId)) {
          favorites.push(workId);
          localStorage.setItem('workFavorites', JSON.stringify(favorites));
          return true;
        }
        return false;
      } catch (err) {
        console.error('æ·»åŠ æ”¶è—å¤±è´¥ï¼š', err);
        return false;
      }
    }

    function removeFavorite(workId) {
      try {
        const favorites = getFavorites();
        const newFavorites = favorites.filter(id => id !== workId);
        localStorage.setItem('workFavorites', JSON.stringify(newFavorites));
        return true;
      } catch (err) {
        console.error('ç§»é™¤æ”¶è—å¤±è´¥ï¼š', err);
        return false;
      }
    }
  </script>
</body>
</html>