<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»é¡µ - å†™çœŸåŒ£å­</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    /* é¡µé¢ç‰¹å®šæ ·å¼ */
    #model-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    .model-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; position: relative; }
    .model-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .model-cover { width: 100%; height: 240px; object-fit: cover; background: #f0f0f0; background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0xMDAgMjVjNDEuNDIgMCA3NSAzMy41OCA3NSA3NXMtMzMuNTggNzUtNzUgNzVTMjUgMTQxLjQyIDI1IDEwMCA1OC41OCAyNSAxMDAgMjV6bTAgMTIwYzU5LjU4IDAgMTA1LTQ1LjQyIDEwNS0xMDVTMTU5LjU4IDAgMTAwIDBTMjUgNDUuNDIgMjUgMTAwczQ1LjQyIDEwNSAxMDUgMTA1eiIvPjxwYXRoIGQ9Ik0xMDAgNzVWMTgwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMTAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvZz48L3N2Zz4='); background-repeat: no-repeat; background-position: center; }
    .model-info { padding: 10px; text-align: center; }
    .empty-tip { text-align: center; padding: 50px; color: #999; font-size: 18px; }
    
    /* æ”¶è—æŒ‰é’®æ ·å¼ */
    .model-favorite-btn, .work-favorite-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      z-index: 10;
      transition: all 0.2s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .model-favorite-btn:hover, .work-favorite-btn:hover {
      background: rgba(0,0,0,0.7);
      transform: scale(1.1);
    }
    
    .model-favorite-btn.favorited, .work-favorite-btn.favorited {
      color: #ffd700;
      background: rgba(255, 215, 0, 0.2);
    }
    
    /* å³é”®èœå•æ ·å¼ */
    .context-menu {
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      min-width: 150px;
      padding: 8px 0;
    }
    
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: background-color 0.2s;
    }
    
    .context-menu-item:hover {
      background-color: #f0f0f0;
    }
    
    .context-menu-item:active {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <!-- å·¦ä¾§å¯¼èˆªæ  -->
  <nav class="sidebar">
    <ul class="nav-menu">
      <li class="nav-item"><a href="index.html" class="nav-link active"><span class="nav-icon">ğŸ </span> ä¸»é¡µ</a></li>
      <li class="nav-item"><a href="search.html" class="nav-link"><span class="nav-icon">ğŸ”</span> æœç´¢</a></li>
      <li class="nav-item"><a href="favorites.html" class="nav-link"><span class="nav-icon">â­</span> æ”¶è—</a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link"><span class="nav-icon">âš™ï¸</span> è®¾ç½®</a></li>
      <li class="nav-item"><a href="about.html" class="nav-link"><span class="nav-icon">â„¹ï¸</span> å…³äº</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="header">
      <h1>å†™çœŸåŒ£å­</h1>
      <div>
        <button id="scan-btn" class="btn scan-btn">æ‰«ææ–‡ä»¶å¤¹</button>
        <button id="refresh-btn" class="btn refresh-btn">åˆ·æ–°åˆ—è¡¨</button>
      </div>
    </div>

    <div id="model-grid">
      <div class="empty-tip">ç‚¹å‡»ä¸Šæ–¹"æ‰«ææ–‡ä»¶å¤¹"æŒ‰é’®å¼€å§‹æ‰«æ</div>
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div class="context-menu" id="model-context-menu">
    <div class="context-menu-item" id="change-cover">æ›´æ¢å°é¢</div>
    <div class="context-menu-item" id="delete-model">åˆ é™¤æ¨¡ç‰¹</div>
  </div>

  <script src="scripts/nav-handler.js"></script>
  <script>
    // å…¼å®¹APIè°ƒç”¨ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
    if (!window.electronAPI) {
      window.electronAPI = {
        scanFolder: () => window.require('electron').ipcRenderer.invoke('scanFolder'),
        getImageBase64: (imagePath) => window.require('electron').ipcRenderer.invoke('getImageBase64', imagePath),
        saveScanResult: (result) => window.require('electron').ipcRenderer.invoke('save-scan-result', result),
        loadScanResult: () => window.require('electron').ipcRenderer.invoke('load-scan-result'),
        showOpenDialog: (options) => window.require('electron').ipcRenderer.invoke('show-open-dialog', options),
      };
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const modelGrid = document.getElementById('model-grid');
      
      // æ”¶è—åŠŸèƒ½ç›¸å…³å‡½æ•°
      function getModelFavorites() {
        try {
          const favorites = localStorage.getItem('modelFavorites');
          return favorites ? JSON.parse(favorites) : [];
        } catch (err) {
          console.error('è·å–æ¨¡ç‰¹æ”¶è—å¤±è´¥ï¼š', err);
          return [];
        }
      }
      
      function isModelFavorite(modelId) {
        const favorites = getModelFavorites();
        return favorites.includes(modelId);
      }
      
      function addModelFavorite(modelId) {
        try {
          const favorites = getModelFavorites();
          if (!favorites.includes(modelId)) {
            favorites.push(modelId);
            localStorage.setItem('modelFavorites', JSON.stringify(favorites));
            return true;
          }
          return false;
        } catch (err) {
          console.error('æ·»åŠ æ¨¡ç‰¹æ”¶è—å¤±è´¥ï¼š', err);
          return false;
        }
      }
      
      function removeModelFavorite(modelId) {
        try {
          const favorites = getModelFavorites();
          const newFavorites = favorites.filter(id => id !== modelId);
          localStorage.setItem('modelFavorites', JSON.stringify(newFavorites));
          return true;
        } catch (err) {
          console.error('ç§»é™¤æ¨¡ç‰¹æ”¶è—å¤±è´¥ï¼š', err);
          return false;
        }
      }
      
      function updateFavoriteButtons() {
        // æ›´æ–°æ¨¡ç‰¹æ”¶è—æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.model-favorite-btn').forEach(btn => {
          const modelId = btn.dataset.modelId;
          if (isModelFavorite(modelId)) {
            btn.classList.add('favorited');
            btn.title = 'å–æ¶ˆæ”¶è—';
          } else {
            btn.classList.remove('favorited');
            btn.title = 'æ”¶è—æ¨¡ç‰¹';
          }
        });
      }
      
      // åŠ è½½ä¿å­˜çš„æ‰«æç»“æœ
      const loadSavedResult = async () => {
        try {
          const result = await window.electronAPI.loadScanResult();
          if (!result || result.length === 0) return null;

          // æ¸²æŸ“æ¨¡ç‰¹å¡ç‰‡
          let html = '';
          result.forEach(model => {
            html += `
              <div class="model-card" data-model-id="${model.id}">
                <button class="model-favorite-btn" data-model-id="${model.id}" title="æ”¶è—æ¨¡ç‰¹"></button>
                <img class="model-cover" src="" data-img-path="${model.cover}">
                <div class="model-info">
                  <div class="model-name">${model.name}</div>
                  <div class="work-count">${model.works.length} ä¸ªä½œå“</div>
                </div>
              </div>
            `;
          });
          modelGrid.innerHTML = html;

          // åŠ è½½å°é¢å›¾ç‰‡
          document.querySelectorAll('.model-card').forEach(async card => {
            const imgPath = card.querySelector('.model-cover').dataset.imgPath;
            const base64 = await window.electronAPI.getImageBase64(imgPath);
            card.querySelector('.model-cover').src = base64;
          });

          // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
          updateFavoriteButtons();

          // ç»‘å®šå¡ç‰‡ç‚¹å‡»äº‹ä»¶
          document.querySelectorAll('.model-card').forEach(card => {
            card.addEventListener('click', () => {
              const modelId = card.dataset.modelId;
              const modelData = result.find(m => m.id === modelId);
              localStorage.setItem('selectedModel', JSON.stringify(modelData));
              window.location.href = 'model-detail.html';
            });
          });

          // ç»‘å®šæ”¶è—æŒ‰é’®äº‹ä»¶
          document.querySelectorAll('.model-favorite-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è·³è½¬åˆ°æ¨¡ç‰¹è¯¦æƒ…é¡µ
              const modelId = btn.dataset.modelId;
              const isFav = isModelFavorite(modelId);
              
              if (isFav) {
                removeModelFavorite(modelId);
                btn.classList.remove('favorited');
                btn.title = 'æ”¶è—æ¨¡ç‰¹';
              } else {
                addModelFavorite(modelId);
                btn.classList.add('favorited');
                btn.title = 'å–æ¶ˆæ”¶è—';
              }
            });
          });

          return result;
        } catch (err) {
          console.error('åŠ è½½å¤±è´¥:', err);
          return null;
        }
      };

      // åˆå§‹åŒ–å³é”®èœå•
    const contextMenu = document.getElementById('model-context-menu');
    let selectedModelCard = null;
    let selectedModelId = null;
    
    // ä¸ºæ¨¡ç‰¹å¡ç‰‡æ·»åŠ å³é”®èœå•äº‹ä»¶
    document.addEventListener('contextmenu', (e) => {
      const modelCard = e.target.closest('.model-card');
      if (modelCard) {
        e.preventDefault();
        
        // æ˜¾ç¤ºå³é”®èœå•
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${e.clientX}px`;
        contextMenu.style.top = `${e.clientY}px`;
        
        // ä¿å­˜é€‰ä¸­çš„å¡ç‰‡
        selectedModelCard = modelCard;
        selectedModelId = modelCard.dataset.modelId;
      }
    });
    
    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­å³é”®èœå•
    document.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });
    
    // æ›´æ¢å°é¢åŠŸèƒ½
    document.getElementById('change-cover').addEventListener('click', async () => {
      if (!selectedModelId || !selectedModelCard) return;
      
      try {
        // è·å–å½“å‰æ¨¡ç‰¹çš„å°é¢è·¯å¾„
        const scanResult = await window.electronAPI.loadScanResult();
        const selectedModel = scanResult.find(model => model.id === selectedModelId);
        const currentCoverPath = selectedModel?.cover;
        
        // æå–å½“å‰å°é¢çš„ä¸Šä¸€çº§ç›®å½•ä½œä¸ºdefaultPath
        const path = window.require('path');
        const defaultPath = currentCoverPath ? path.dirname(path.dirname(currentCoverPath)) : '';
        
        // ä½¿ç”¨electronAPI.showOpenDialogé€‰æ‹©æ–°å°é¢
        const result = await window.electronAPI.showOpenDialog({
          properties: ['openFile'],
          filters: [
            { name: 'å›¾ç‰‡æ–‡ä»¶', extensions: ['jpg', 'jpeg', 'png', 'gif'] }
          ],
          defaultPath: defaultPath
        });
        
        if (!result.canceled && result.filePaths.length > 0) {
          const newCoverPath = result.filePaths[0];
          
          // æ›´æ–°æ¨¡ç‰¹å¡ç‰‡çš„å°é¢
          const imgElement = selectedModelCard.querySelector('.model-cover');
          const base64 = await window.electronAPI.getImageBase64(newCoverPath);
          imgElement.src = base64;
          imgElement.dataset.imgPath = newCoverPath;
          
          // æ›´æ–°ä¿å­˜çš„æ•°æ®
          const scanResult = await window.electronAPI.loadScanResult();
          const modelIndex = scanResult.findIndex(model => model.id === selectedModelId);
          if (modelIndex !== -1) {
            scanResult[modelIndex].cover = newCoverPath;
            await window.electronAPI.saveScanResult(scanResult);
            // åŒæ—¶æ›´æ–°localStorageï¼Œå› ä¸ºstorageäº‹ä»¶åœ¨åŒä¸€çª—å£ä¸è§¦å‘
            localStorage.setItem('scanResult', JSON.stringify(scanResult));
          }
        }
      } catch (err) {
        console.error('æ›´æ¢å°é¢å¤±è´¥ï¼š', err);
        alert('æ›´æ¢å°é¢å¤±è´¥ï¼š' + err.message);
      } finally {
        contextMenu.style.display = 'none';
      }
    });
    
    // åˆ é™¤æ¨¡ç‰¹åŠŸèƒ½
    document.getElementById('delete-model').addEventListener('click', async () => {
      if (!selectedModelId || !selectedModelCard) return;
      
      if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ¨¡ç‰¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        try {
          // è·å–å½“å‰æ‰«æç»“æœ
          const scanResult = await window.electronAPI.loadScanResult();
          
          // è¿‡æ»¤æ‰è¦åˆ é™¤çš„æ¨¡ç‰¹
          const newScanResult = scanResult.filter(model => model.id !== selectedModelId);
          
          // ä¿å­˜æ›´æ–°åçš„ç»“æœ
          await window.electronAPI.saveScanResult(newScanResult);
          
          // ä»DOMä¸­ç§»é™¤å¡ç‰‡
          selectedModelCard.remove();
          
          // å¦‚æœæ²¡æœ‰æ¨¡ç‰¹äº†ï¼Œæ˜¾ç¤ºç©ºæç¤º
          if (document.querySelectorAll('.model-card').length === 0) {
            modelGrid.innerHTML = '<div class="empty-tip">æ²¡æœ‰æ¨¡ç‰¹æ•°æ®</div>';
          }
        } catch (err) {
          console.error('åˆ é™¤æ¨¡ç‰¹å¤±è´¥ï¼š', err);
          alert('åˆ é™¤æ¨¡ç‰¹å¤±è´¥ï¼š' + err.message);
        } finally {
          contextMenu.style.display = 'none';
        }
      } else {
        contextMenu.style.display = 'none';
      }
    });

    // åˆå§‹åŒ–åŠ è½½
    await loadSavedResult();

    // æ‰«ææŒ‰é’®äº‹ä»¶
    document.getElementById('scan-btn').addEventListener('click', async () => {
        modelGrid.innerHTML = '<div class="empty-tip">æ­£åœ¨æ‰«æ...</div>';
        try {
          const newResult = await window.electronAPI.scanFolder();
          if (newResult.length === 0) {
            modelGrid.innerHTML = '<div class="empty-tip">æœªæ‰«æåˆ°ä»»ä½•æ¨¡ç‰¹æ•°æ®</div>';
            return;
          }

          // è·å–ç°æœ‰çš„æ‰«æç»“æœ
          const existingResult = await window.electronAPI.loadScanResult();
          
          // åˆå¹¶æ–°æ‰«æç»“æœä¸ç°æœ‰ç»“æœï¼Œé¿å…è¦†ç›–
          const mergedResult = mergeScanResults(existingResult, newResult);
          
          // ä¿å­˜åˆå¹¶åçš„ç»“æœå¹¶é‡æ–°åŠ è½½
          await window.electronAPI.saveScanResult(mergedResult);
          await loadSavedResult();
        } catch (err) {
          modelGrid.innerHTML = `<div class="empty-tip" style="color:red;">æ‰«æå¤±è´¥ï¼š${err.message}</div>`;
        }
      });
      
      // åˆå¹¶æ‰«æç»“æœçš„å‡½æ•°
      function mergeScanResults(existing, newResults) {
        if (!existing || existing.length === 0) {
          return newResults;
        }
        
        // åˆ›å»ºç°æœ‰æ¨¡ç‰¹çš„æ˜ å°„ï¼Œä»¥æ¨¡ç‰¹åç§°ä¸ºé”®
        const existingModelsMap = new Map(existing.map(model => [model.name, model]));
        
        // å¤„ç†æ–°æ‰«æçš„æ¨¡ç‰¹
        newResults.forEach(newModel => {
          if (existingModelsMap.has(newModel.name)) {
            // æ¨¡ç‰¹å·²å­˜åœ¨ï¼Œåˆå¹¶ä½œå“
            const existingModel = existingModelsMap.get(newModel.name);
            
            // åˆ›å»ºç°æœ‰ä½œå“çš„æ˜ å°„ï¼Œä»¥ä½œå“åç§°ä¸ºé”®
            const existingWorksMap = new Map(existingModel.works.map(work => [work.name, work]));
            
            // å¤„ç†æ–°æ‰«æçš„ä½œå“
            newModel.works.forEach(newWork => {
              if (!existingWorksMap.has(newWork.name)) {
                // ä½œå“ä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°ç°æœ‰æ¨¡ç‰¹çš„ä½œå“åˆ—è¡¨
                existingWorksMap.set(newWork.name, newWork);
              } else {
                // ä½œå“å·²å­˜åœ¨ï¼Œä¿ç•™ç°æœ‰ä½œå“
                // å¯ä»¥æ ¹æ®éœ€è¦å†³å®šæ˜¯å¦æ›´æ–°ç°æœ‰ä½œå“çš„ä¿¡æ¯
              }
            });
            
            // æ›´æ–°æ¨¡ç‰¹çš„ä½œå“åˆ—è¡¨
            existingModel.works = Array.from(existingWorksMap.values());
            existingModel.cover = existingModel.works[0]?.cover || existingModel.cover;
          } else {
            // æ¨¡ç‰¹ä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°ç°æœ‰ç»“æœ
            existingModelsMap.set(newModel.name, newModel);
          }
        });
        
        // å°†æ˜ å°„è½¬æ¢å›æ•°ç»„å¹¶è¿”å›
        return Array.from(existingModelsMap.values());
      }

      // åˆ·æ–°æŒ‰é’®äº‹ä»¶
      document.getElementById('refresh-btn').addEventListener('click', async () => {
        modelGrid.innerHTML = '<div class="empty-tip">æ­£åœ¨åˆ·æ–°åˆ—è¡¨...</div>';
        await loadSavedResult();
      });
    });
  </script>
</body>
</html>