<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„æ”¶è— - å†™çœŸåŒ£å­</title>
  <link rel="stylesheet" href="styles/main.css">
  <!-- æ”¶è—é¡µç‰¹å®šæ ·å¼ -->
  <style>
    /* æ”¶è—é¡µç‰¹å®šæ ·å¼ */
    .empty-favorites {
      text-align: center;
      padding: 100px 20px;
      color: #666;
    }
    .empty-favorites h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .empty-favorites p {
      font-size: 16px;
      margin-bottom: 30px;
    }
    .back-to-home {
      display: inline-block;
      padding: 10px 20px;
      background: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .back-to-home:hover {
      background: #2980b9;
    }
    
    /* æ”¶è—æŒ‰é’®æ ·å¼ */
    .model-favorite-btn, .work-favorite-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      transition: all 0.2s;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .model-favorite-btn:hover, .work-favorite-btn:hover {
      background: rgba(0, 0, 0, 0.7);
      transform: scale(1.1);
    }
    
    .model-favorite-btn.favorited, .work-favorite-btn.favorited {
      color: gold;
      background: rgba(255, 215, 0, 0.3);
    }
    
    /* ç½‘æ ¼å¸ƒå±€ */
    #model-favorites-grid, #work-favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    /* æ”¶è—åˆ†åŒºæ ‡é¢˜ */
    .favorite-section h2 {
      margin: 30px 0 20px 0;
      font-size: 20px;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    
    /* å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ */
    .image-viewer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 99999; display: none; }
    .viewer-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
    .viewer-image { max-width: 90%; max-height: 90%; transition: transform 0.2s ease; cursor: grab; }
    .viewer-image.grabbing { cursor: grabbing; }
    .viewer-info { position: absolute; top: 20px; left: 20px; color: white; font-size: 14px; }
    .viewer-close { position: absolute; top: 20px; right: 20px; font-size: 24px; color: white; cursor: pointer; }
    .viewer-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
    .viewer-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer; }
    .viewer-btn:hover { background: rgba(255,255,255,0.3); }
    
    /* åŠ è½½è¦†ç›–å±‚ */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); color: white; display: none; align-items: center; justify-content: center; font-size: 20px; z-index: 10000; }
  </style>
</head>
<body>
  <!-- å·¦ä¾§å¯¼èˆªæ  -->
  <nav class="sidebar">
    <ul class="nav-menu">
      <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span> ä¸»é¡µ</a></li>
      <li class="nav-item"><a href="search.html" class="nav-link"><span class="nav-icon">ğŸ”</span> æœç´¢</a></li>
      <li class="nav-item"><a href="favorites.html" class="nav-link active"><span class="nav-icon">â­</span> æ”¶è—</a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link"><span class="nav-icon">âš™ï¸</span> è®¾ç½®</a></li>
      <li class="nav-item"><a href="about.html" class="nav-link"><span class="nav-icon">â„¹ï¸</span> å…³äº</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="header">
      <h1>æˆ‘çš„æ”¶è—</h1>
      <button id="refresh-btn" style="margin-left: 20px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ·æ–°</button>
    </div>

    <!-- æ”¶è—çš„æ¨¡ç‰¹éƒ¨åˆ† -->
    <div class="favorite-section">
      <h2>æ”¶è—çš„æ¨¡ç‰¹</h2>
      <div id="model-favorites-grid"></div>
    </div>

    <!-- æ”¶è—çš„ä½œå“éƒ¨åˆ† -->
    <div class="favorite-section">
      <h2>æ”¶è—çš„ä½œå“</h2>
      <div id="work-favorites-grid"></div>
    </div>
  </div>

  <div class="loading-overlay" id="loading-overlay">åŠ è½½å›¾ç‰‡æŸ¥çœ‹å™¨...</div>

  <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
  <div class="image-viewer" id="image-viewer">
    <div class="viewer-content" id="viewer-content">
      <img src="" alt="æŸ¥çœ‹å›¾ç‰‡" class="viewer-image" id="viewer-image">
      <div class="viewer-info" id="viewer-info">1/1 (100%)</div>
      <div class="viewer-close" id="viewer-close">Ã—</div>
      <div class="viewer-controls">
        <button class="viewer-btn" id="btn-prev">ä¸Šä¸€å¼ </button>
        <button class="viewer-btn" id="btn-zoom-out">-</button>
        <button class="viewer-btn" id="btn-reset">100%</button>
        <button class="viewer-btn" id="btn-zoom-in">+</button>
        <button class="viewer-btn" id="btn-next">ä¸‹ä¸€å¼ </button>
      </div>
    </div>
  </div>

  <script src="scripts/nav-handler.js"></script>
  <script>
    // å…¼å®¹APIè°ƒç”¨ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
    if (!window.electronAPI) {
      window.electronAPI = {
        scanFolder: () => window.require('electron').ipcRenderer.invoke('scanFolder'),
        getImageBase64: (imagePath) => window.require('electron').ipcRenderer.invoke('getImageBase64', imagePath),
        saveScanResult: (result) => window.require('electron').ipcRenderer.invoke('save-scan-result', result),
        loadScanResult: () => window.require('electron').ipcRenderer.invoke('load-scan-result'),
        getWheelSettings: () => window.require('electron').ipcRenderer.invoke('get-wheel-settings')
      };
    } else {
      // ç¡®ä¿æ»šè½®è®¾ç½®æ–¹æ³•å­˜åœ¨
      if (!window.electronAPI.getWheelSettings) {
        window.electronAPI.getWheelSettings = () => window.require('electron').ipcRenderer.invoke('get-wheel-settings');
      }
    }

    // å…¨å±€å˜é‡
    let currentImages = [];
    let currentIndex = 0;
    let zoomLevel = 1.0;
    let currentWork = null;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    // æ»šè½®è®¾ç½®
    let wheelSettings = {
      wheelMode: 'zoom',  // zoom=ç¼©æ”¾ï¼Œpage=ç¿»é¡µï¼Œnone=æ— æ“ä½œ
      zoomStep: 0.05
    };
    
    // DOMå…ƒç´ 
    const modelGrid = document.getElementById('model-favorites-grid');
    const workGrid = document.getElementById('work-favorites-grid');
    const loadingOverlay = document.getElementById('loading-overlay');
    const imageViewer = document.getElementById('image-viewer');
    const viewerImage = document.getElementById('viewer-image');
    const viewerInfo = document.getElementById('viewer-info');
    const viewerClose = document.getElementById('viewer-close');
    const viewerContent = document.getElementById('viewer-content');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnReset = document.getElementById('btn-reset');
    
    // ç…§ç‰‡æŸ¥çœ‹å™¨åŠŸèƒ½å‡½æ•°
    function updateViewerInfo() {
      const percent = Math.round(zoomLevel * 100);
      viewerInfo.textContent = `${currentIndex + 1}/${currentImages.length} (${percent}%)`;
    }
    
    async function loadImageByIndex(index) {
      if (index < 0 || index >= currentImages.length) return;
      
      currentIndex = index;
      translateX = 0;
      translateY = 0;
      
      try {
        const base64 = await window.electronAPI.getImageBase64(currentImages[currentIndex]);
        viewerImage.src = base64;
        viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        updateViewerInfo();
        imageViewer.style.display = 'block';
      } catch (err) {
        alert('åŠ è½½å›¾ç‰‡å¤±è´¥ï¼š' + err.message);
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }
    
    function zoomImage(delta) {
      zoomLevel += delta;
      zoomLevel = Math.max(0.1, Math.min(3.0, zoomLevel));
      viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
      updateViewerInfo();
    }
    
    function resetZoom() {
      zoomLevel = 1.0;
      translateX = 0;
      translateY = 0;
      viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
      updateViewerInfo();
    }
    
    function closeViewer() {
      imageViewer.style.display = 'none';
      currentImages = [];
      currentIndex = 0;
      currentWork = null;
      resetZoom();
    }
    
    // ç»‘å®šç…§ç‰‡æŸ¥çœ‹å™¨äº‹ä»¶
    function bindImageViewerEvents() {
      // æŒ‰é’®äº‹ä»¶
      btnPrev.addEventListener('click', () => loadImageByIndex(currentIndex - 1));
      btnNext.addEventListener('click', () => loadImageByIndex(currentIndex + 1));
      btnZoomIn.addEventListener('click', () => zoomImage(wheelSettings.zoomStep));
      btnZoomOut.addEventListener('click', () => zoomImage(-wheelSettings.zoomStep));
      btnReset.addEventListener('click', resetZoom);
      viewerClose.addEventListener('click', closeViewer);
      
      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (imageViewer.style.display !== 'block') return;
        
        switch (e.key) {
          case 'ArrowRight':
            e.preventDefault();
            loadImageByIndex(currentIndex + 1);
            break;
          case 'ArrowLeft':
            e.preventDefault();
            loadImageByIndex(currentIndex - 1);
            break;
          case 'Escape':
            e.preventDefault();
            closeViewer();
            break;
          case '+':
            if (e.ctrlKey) {
              e.preventDefault();
              zoomImage(wheelSettings.zoomStep);
            }
            break;
          case '-':
            if (e.ctrlKey) {
              e.preventDefault();
              zoomImage(-wheelSettings.zoomStep);
            }
            break;
          case '0':
            if (e.ctrlKey) {
              e.preventDefault();
              resetZoom();
            }
            break;
        }
      });
      
      // æ»šè½®äº‹ä»¶å¤„ç†å‡½æ•°
      function handleWheelEvent(e) {
        e.preventDefault();
        
        // æ ¹æ®æ»šè½®æ¨¡å¼å¤„ç†
        switch (wheelSettings.wheelMode) {
          case 'page':
            // æ»šè½®ç¿»é¡µï¼šå‘ä¸Š/å‘å·¦=ä¸Šä¸€å¼ ï¼Œå‘ä¸‹/å‘å³=ä¸‹ä¸€å¼ 
            if (e.deltaY > 0 || e.deltaX > 0) {
              loadImageByIndex(currentIndex + 1); // ä¸‹ä¸€å¼ 
            } else {
              loadImageByIndex(currentIndex - 1); // ä¸Šä¸€å¼ 
            }
            break;
          case 'zoom':
            // æ»šè½®ç¼©æ”¾ï¼šå‘ä¸Š=æ”¾å¤§ï¼Œå‘ä¸‹=ç¼©å°
            if (e.deltaY < 0) {
              zoomImage(wheelSettings.zoomStep); // æ”¾å¤§
            } else {
              zoomImage(-wheelSettings.zoomStep); // ç¼©å°
            }
            break;
          case 'none':
            // æ— æ“ä½œ
            break;
        }
      }
      
      // ç»‘å®šæ»šè½®äº‹ä»¶
      viewerContent.addEventListener('wheel', handleWheelEvent);
      
      // å›¾ç‰‡æ‹–æ‹½
      viewerImage.addEventListener('mousedown', (e) => {
        if (zoomLevel <= 1.0) return;
        isDragging = true;
        viewerImage.classList.add('grabbing');
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
      });
      
      document.addEventListener('mouseup', () => {
        isDragging = false;
        viewerImage.classList.remove('grabbing');
      });
      
      // ç‚¹å‡»ç©ºç™½å¤„å…³é—­
      imageViewer.addEventListener('click', (e) => {
        if (e.target === imageViewer) {
          closeViewer();
        }
      });
    }
    
    // ä½œå“æ”¶è—åŠŸèƒ½ç›¸å…³å‡½æ•°
    function getWorkFavorites() {
      try {
        const favorites = localStorage.getItem('workFavorites');
        return favorites ? JSON.parse(favorites) : [];
      } catch (err) {
        console.error('è·å–ä½œå“æ”¶è—å¤±è´¥ï¼š', err);
        return [];
      }
    }

    function removeWorkFavorite(workId) {
      try {
        const favorites = getWorkFavorites();
        const newFavorites = favorites.filter(id => id !== workId);
        localStorage.setItem('workFavorites', JSON.stringify(newFavorites));
        return true;
      } catch (err) {
        console.error('ç§»é™¤ä½œå“æ”¶è—å¤±è´¥ï¼š', err);
        return false;
      }
    }

    // æ¨¡ç‰¹æ”¶è—åŠŸèƒ½ç›¸å…³å‡½æ•°
    function getModelFavorites() {
      try {
        const favorites = localStorage.getItem('modelFavorites');
        return favorites ? JSON.parse(favorites) : [];
      } catch (err) {
        console.error('è·å–æ¨¡ç‰¹æ”¶è—å¤±è´¥ï¼š', err);
        return [];
      }
    }

    function removeModelFavorite(modelId) {
      try {
        const favorites = getModelFavorites();
        const newFavorites = favorites.filter(id => id !== modelId);
        localStorage.setItem('modelFavorites', JSON.stringify(newFavorites));
        return true;
      } catch (err) {
        console.error('ç§»é™¤æ¨¡ç‰¹æ”¶è—å¤±è´¥ï¼š', err);
        return false;
      }
    }

    // åŠ è½½æ‰€æœ‰æ¨¡ç‰¹æ•°æ®
    async function loadAllModelData() {
      try {
        console.log('Loading all model data...');
        // ä½¿ç”¨electronAPI.loadScanResult()è·å–æ¨¡ç‰¹æ•°æ®
        const modelData = await electronAPI.loadScanResult();
        console.log('Model data loaded:', modelData.length, 'models');
        if (modelData && modelData.length > 0) {
          console.log('First model cover:', modelData[0].cover);
          if (modelData[0].works && modelData[0].works.length > 0) {
            console.log('First model first work cover:', modelData[0].works[0].cover);
          }
        }
        return modelData ? modelData : [];
      } catch (err) {
        console.error('åŠ è½½æ¨¡ç‰¹æ•°æ®å¤±è´¥ï¼š', err);
        return [];
      }
    }

    // æ˜¾ç¤ºæ”¶è—çš„æ¨¡ç‰¹
    async function showModelFavorites() {
      const favoriteModelIds = getModelFavorites();
      const allModels = await loadAllModelData();
      
      if (favoriteModelIds.length === 0) {
        // æ²¡æœ‰æ”¶è—æ¨¡ç‰¹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        modelGrid.innerHTML = `
          <div class="empty-favorites">
            <h2>æš‚æ— æ”¶è—æ¨¡ç‰¹</h2>
            <p>æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ¨¡ç‰¹ï¼Œå¿«å»ä¸»é¡µçœ‹çœ‹å§ï¼</p>
            <a href="index.html" class="back-to-home">è¿”å›ä¸»é¡µ</a>
          </div>
        `;
        return;
      }
      
      // æ”¶é›†æ‰€æœ‰æ”¶è—çš„æ¨¡ç‰¹
      const favoriteModels = allModels.filter(model => favoriteModelIds.includes(model.id));
      
      // ç”Ÿæˆæ¨¡ç‰¹å¡ç‰‡
      let html = '';
      favoriteModels.forEach(model => {
        // è·å–æ¨¡ç‰¹çš„å°é¢ï¼Œä¼˜å…ˆä½¿ç”¨æ¨¡ç‰¹è‡ªå·±çš„coverå±æ€§
        let modelCover = model.cover || '';
        // å¦‚æœæ²¡æœ‰æ¨¡ç‰¹å°é¢ï¼Œå›é€€åˆ°ç¬¬ä¸€å¼ ä½œå“å°é¢
        if (!modelCover && model.works && model.works.length > 0) {
          modelCover = model.works[0].cover;
        }
        
        html += `
          <div class="model-card" data-model-id="${model.id}">
            <button class="model-favorite-btn favorited" data-model-id="${model.id}" title="å–æ¶ˆæ”¶è—"></button>
            <img class="model-cover" src="" data-img-path="${modelCover}">
            <div class="model-info">
              <div class="model-name">${model.name}</div>
              <div class="model-works-count">${model.works.length} ä¸ªä½œå“</div>
            </div>
          </div>
        `;
      });
      
      modelGrid.innerHTML = html;
      
      // åŠ è½½å°é¢å›¾ç‰‡
      document.querySelectorAll('.model-card').forEach(async card => {
        const imgPath = card.querySelector('.model-cover').dataset.imgPath;
        if (imgPath) {
          try {
            // ä½¿ç”¨electronAPIè·å–å›¾ç‰‡base64ï¼ˆå¦‚æœåœ¨Electronç¯å¢ƒä¸­ï¼‰
            if (typeof electronAPI !== 'undefined') {
              const base64 = await electronAPI.getImageBase64(imgPath);
              card.querySelector('.model-cover').src = base64;
            }
          } catch (err) {
            console.error('åŠ è½½æ¨¡ç‰¹å°é¢å¤±è´¥ï¼š', err);
          }
        }
      });
    }

    // æ˜¾ç¤ºæ”¶è—çš„ä½œå“
    async function showWorkFavorites() {
      const favoriteWorkIds = getWorkFavorites();
      const allModels = await loadAllModelData();
      
      if (favoriteWorkIds.length === 0) {
        // æ²¡æœ‰æ”¶è—ä½œå“ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        workGrid.innerHTML = `
          <div class="empty-favorites">
            <h2>æš‚æ— æ”¶è—ä½œå“</h2>
            <p>æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•ä½œå“ï¼Œå¿«å»ä¸»é¡µçœ‹çœ‹å§ï¼</p>
            <a href="index.html" class="back-to-home">è¿”å›ä¸»é¡µ</a>
          </div>
        `;
        return;
      }
      
      // æ”¶é›†æ‰€æœ‰æ”¶è—çš„ä½œå“
      const favoriteWorks = [];
      allModels.forEach(model => {
        model.works.forEach(work => {
          if (favoriteWorkIds.includes(work.id)) {
            favoriteWorks.push({ ...work, modelName: model.name, modelId: model.id });
          }
        });
      });
      
      // ç”Ÿæˆä½œå“å¡ç‰‡
      let html = '';
      favoriteWorks.forEach(work => {
        html += `
          <div class="work-card" data-model-id="${work.modelId}" data-work-id="${work.id}">
            <button class="work-favorite-btn favorited" data-work-id="${work.id}" title="å–æ¶ˆæ”¶è—"></button>
            <img class="work-cover" src="" data-img-path="${work.cover}">
            <div class="work-info">
              <div>${work.name}</div>
              <div style="font-size:12px;color:#666">${work.modelName}</div>
              <div style="font-size:12px;color:#666">${work.images.length} å¼ å›¾ç‰‡</div>
            </div>
          </div>
        `;
      });
      
      workGrid.innerHTML = html;
      
      // åŠ è½½å°é¢å›¾ç‰‡
      document.querySelectorAll('.work-card').forEach(async card => {
        const imgPath = card.querySelector('.work-cover').dataset.imgPath;
        try {
          // ä½¿ç”¨electronAPIè·å–å›¾ç‰‡base64ï¼ˆå¦‚æœåœ¨Electronç¯å¢ƒä¸­ï¼‰
          if (typeof electronAPI !== 'undefined') {
            const base64 = await electronAPI.getImageBase64(imgPath);
            card.querySelector('.work-cover').src = base64;
          }
        } catch (err) {
          console.error('åŠ è½½å°é¢å›¾ç‰‡å¤±è´¥ï¼š', err);
        }
      });
    }

    // åˆ·æ–°æ”¶è—åˆ—è¡¨
    async function refreshFavorites() {
      try {
        await showModelFavorites();
        await showWorkFavorites();
      } catch (err) {
        console.error('åˆ·æ–°æ”¶è—åˆ—è¡¨å¤±è´¥ï¼š', err);
      }
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // ç»‘å®šç…§ç‰‡æŸ¥çœ‹å™¨äº‹ä»¶
      bindImageViewerEvents();
      // æ·»åŠ localStorageçš„storageäº‹ä»¶ç›‘å¬
      window.addEventListener('storage', (e) => {
        console.log('Storage event:', e.key, e.newValue ? e.newValue.length : 0);
        if (e.key === 'scanResult') {
          // å½“æ‰«æç»“æœå˜åŒ–æ—¶åˆ·æ–°æ”¶è—åˆ—è¡¨
          console.log('ScanResult changed, refreshing favorites...');
          refreshFavorites();
        }
      });
      
      // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
      document.addEventListener('visibilitychange', () => {
        console.log('Visibility change:', document.hidden ? 'hidden' : 'visible');
        if (!document.hidden) {
          // å½“é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°æ•°æ®
          refreshFavorites();
        }
      });
      
      // åˆ·æ–°æŒ‰é’®äº‹ä»¶
      const refreshBtn = document.getElementById('refresh-btn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          console.log('Manual refresh clicked');
          refreshFavorites();
        });
      }
      
      // å®šæœŸæ£€æŸ¥å¹¶åˆ·æ–°ï¼ˆä¸´æ—¶è°ƒè¯•ç”¨ï¼‰
      setInterval(() => {
        console.log('Auto-refresh check...');
        refreshFavorites();
      }, 5000);
      // æ¨¡ç‰¹å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      modelGrid.addEventListener('click', async (e) => {
        const card = e.target.closest('.model-card');
        const favoriteBtn = e.target.closest('.model-favorite-btn');
        
        if (favoriteBtn) {
          // å–æ¶ˆæ”¶è—æ¨¡ç‰¹
          e.stopPropagation();
          const modelId = favoriteBtn.dataset.modelId;
          if (removeModelFavorite(modelId)) {
            // é‡æ–°åŠ è½½æ”¶è—åˆ—è¡¨
            await showModelFavorites();
          }
        } else if (card) {
          // ç‚¹å‡»æ¨¡ç‰¹å¡ç‰‡ï¼Œè·³è½¬åˆ°æ¨¡ç‰¹è¯¦æƒ…é¡µ
          const modelId = card.dataset.modelId;
          
          // åŠ è½½æ¨¡ç‰¹æ•°æ®
          const allModels = await loadAllModelData();
          const model = allModels.find(m => m.id === modelId);
          
          if (model) {
            // å°†æ¨¡ç‰¹æ•°æ®ä¿å­˜åˆ°localStorage
            localStorage.setItem('selectedModel', JSON.stringify(model));
            // è·³è½¬åˆ°ä½œå“è¯¦æƒ…é¡µ
            window.location.href = 'model-detail.html';
          }
        }
      });

      // ä½œå“å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      workGrid.addEventListener('click', async (e) => {
        const card = e.target.closest('.work-card');
        const favoriteBtn = e.target.closest('.work-favorite-btn');
        
        if (favoriteBtn) {
          // å–æ¶ˆæ”¶è—ä½œå“
          e.stopPropagation();
          const workId = favoriteBtn.dataset.workId;
          if (removeWorkFavorite(workId)) {
            // é‡æ–°åŠ è½½æ”¶è—åˆ—è¡¨
            await showWorkFavorites();
          }
        } else if (card) {
          // ç‚¹å‡»ä½œå“å¡ç‰‡ï¼Œç›´æ¥æ‰“å¼€ç…§ç‰‡æŸ¥çœ‹å™¨
          const modelId = card.dataset.modelId;
          const workId = card.dataset.workId;
          
          // åŠ è½½æ¨¡ç‰¹æ•°æ®
          const allModels = await loadAllModelData();
          const model = allModels.find(m => m.id === modelId);
          
          if (model) {
            // æ‰¾åˆ°å¯¹åº”çš„ä½œå“
            const work = model.works.find(w => w.id === workId);
            
            if (work) {
              // è®¾ç½®å½“å‰ä½œå“å’Œå›¾ç‰‡
              currentWork = work;
              currentImages = work.images;
              currentIndex = 0;
              zoomLevel = 1.0;
              translateX = 0;
              translateY = 0;
              
              // æ˜¾ç¤ºåŠ è½½è¦†ç›–å±‚
              loadingOverlay.style.display = 'flex';
              
              try {
                // åŠ è½½ç¬¬ä¸€å¼ å›¾ç‰‡
                const base64 = await window.electronAPI.getImageBase64(currentImages[currentIndex]);
                viewerImage.src = base64;
                viewerImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
                updateViewerInfo();
                // æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹å™¨
                imageViewer.style.display = 'block';
              } catch (err) {
                alert('åŠ è½½å›¾ç‰‡å¤±è´¥ï¼š' + err.message);
              } finally {
                // éšè—åŠ è½½è¦†ç›–å±‚
                loadingOverlay.style.display = 'none';
              }
            }
          }
        }
      });
    }

    // åŠ è½½é…ç½®
    async function loadAllConfigs() {
      try {
        const loadedWheel = await window.electronAPI.getWheelSettings();
        wheelSettings = { ...wheelSettings, ...loadedWheel };
        console.log('æ»šè½®è®¾ç½®å·²åŠ è½½ï¼š', wheelSettings);
      } catch (err) {
        console.error('åŠ è½½é…ç½®å¤±è´¥ï¼š', err);
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllConfigs();
      bindEvents();
      await showModelFavorites();
      await showWorkFavorites();
    });
  </script>
</body>
</html>